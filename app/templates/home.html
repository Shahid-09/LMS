<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <style>
        /* Sidebar styling */
        .sidebar {
            height: 100vh;
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            width: 330px;
            background-color: #2c3e50;
            color: white;
            padding-top: 30px;
            transition: width 0.3s ease;
            overflow-x: hidden;
        }

        .sidebar.collapsed {
            width: 60px;
        }

        .sidebar h2 {
            text-align: center;
            font-size: 1.75rem;
            padding-bottom: 30px;
            transition: opacity 0.3s ease;
        }

        .sidebar.collapsed h2 {
            opacity: 0;
        }

        .sidebar button {
            width: 100%;
            margin-bottom: 12px;
            /* border-radius: 30px; */
            font-size: 1.1rem;
            text-align: left;
            padding: 12px 20px;
            transition: background-color 0.3s ease;
        }

        .sidebar button:hover {
            background-color: #34495e;
        }

        .sidebar.collapsed button {
            opacity: 0;
        }

        /* Content wrapper */
        .content {
            margin-left: 320px;
            padding: 30px;
            transition: margin-left 0.3s ease;
            background-color: #ecf0f1;
        }

        .content.collapsed {
            margin-left: 60px;
        }

        .toggle-btn {
            position: absolute;
            top: 20px;
            right: -12px;
            width: 45px;
            height: 40px;
            background-color: #2c3e50;
            border-radius: 50%;
            color: white;
            font-size: 23px;
            text-align: center;
            line-height: 40px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Dropdown styling */
        select.form-control {
            padding: 5px 15px;
            font-size: 1.1rem;
            border-radius: 8px;
            width: 230px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Table styling */
        .table {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .table thead {
            background-color: #2c3e50;
            color: white;
        }

        .table th,
        .table td {
            vertical-align: middle;
            text-align: center;
            padding: 12px;
        }

        .table td {
            border-top: 1px solid #ddd;
        }

        /* Button styling */
        .btn-add {
            border-radius: 25px;
            padding: 10px 30px;
            font-size: 1.1rem;
            width: 200px;
            height: 50px;
            text-align: center;
            display: inline-block;
        }

        /* Logout button styling */
        .logout-btn {
            display: block;
            /* Ensures it is a block-level element */
            width: 50%;
            /* Ensure it takes 50% of its container's width */
            margin-top: 400px;
            background-color: #e74c3c;
            color: white;
            font-size: 1.1rem;
            /* border-radius: 30px; */
            padding: 12px 20px;
            transition: background-color 0.3s ease;
            border: none;
            text-align: center;
            margin-left: auto;
            /* Center align the button within its container */
            margin-right: auto;
            /* Center align the button within its container */
        }

        .logout-btn:hover {
            background-color: #c0392b;
            color: white;
        }

        /* Search Icon Styling */
        .search-container {
            display: flex;
            align-items: center;
            position: relative;
        }

        .search-container input {
            flex: 1;
            border-radius: 25px;
            padding-left: 15px;
            padding-right: 40px;
            transition: all 0.3s ease;
            height: 45px;
            width: 170px;
        }

        .search-container .search-icon {
            margin-left: -30px;
            pointer-events: auto;
            font-size: 22px;
            cursor: pointer;
            color: #2c3e50;
            transition: color 0.3s ease;
        }

        .search-container .search-icon:hover {
            color: #8701fc;
        }
/* Sidebar styling */
.sidebar {
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            width: 330px;
            background-color: #2c3e50;
            color: white;
            padding-top: 30px;
            transition: width 0.3s ease;
            overflow-x: hidden;
        }

        .sidebar.collapsed {
            width: 60px;
        }

        /* Content wrapper */
        .content {
            margin-left: 330px;
            padding: 30px;
            transition: margin-left 0.3s ease;
            background-color: #ecf0f1;
        }

        .content.collapsed {
            margin-left: 60px;
        }

        /* Ensure toggle button is outside the sidebar and fully clickable */
.toggle-btn {
    position: fixed; /* Fixed so it doesn't move with the content */
    top: 20px;
    left: 285px; /* Adjust based on collapsed sidebar width */
    width: 45px;
    height: 40px;
    background-color: #2c3e50;
    border-radius: 50%;
    color: white;
    font-size: 23px;
    text-align: center;
    line-height: 40px;
    cursor: pointer;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    z-index: 1000; /* Ensures it stays above all other elements */
    transition: left 0.3s ease;
}

/* Move the toggle button closer to the sidebar when expanded */
.sidebar.collapsed + .toggle-btn {
    left: 10px; /* Adjust based on your collapsed sidebar's width */
}

        /* Sidebar collapsed state */
.sidebar.collapsed button {
    opacity: 1; /* Keep button opacity visible */
}

/* Hide text (span) when collapsed */
.sidebar.collapsed span {
    display: none;
}

/* Keep icon visible */
.sidebar.collapsed i {
    display: inline-block;
}

.sidebar.collapsed button {
    opacity: 1; /* Ensures button is visible */
    background-color: none;
}


.sidebar.collapsed i {
    display: inline-block; /* Ensures the icon remains visible */
}

.sidebar.collapsed .sidebar-text {
  display: none; /* Hide the text */
}

.sidebar.collapsed .sidebar-icon {
  display: inline-block; /* Ensure the icon is always visible */
}   

/* Icon visibility when sidebar is collapsed */
.sidebar.collapsed .sidebar-icon i {
  display: inline-block; /* Keep icon visible */
}

        
    </style>
</head>

<body>
    <div class="container-fluid">
        <!-- Sidebar -->
        <!-- <div class="sidebar" id="sidebar">
            <div class="toggle-btn" onclick="toggleSidebar()">&#9664;</div>
            <h2 id="institute-name">{{ institute_name }}</h2>
            <button class="btn btn-primary" onclick="navigateTo('/home')">Home</button>
            <button class="btn btn-primary" onclick="navigateTo('/course')">Course</button>
            <button class="btn btn logout-btn " class="btn btn-danger" onclick="navigateTo('/logout')">Logout</button>

        </div> -->

        <div class="sidebar" id="sidebar">
            <!-- <div class="toggle-btn" onclick="toggleSidebar()">&#9664;</div> -->
            <h2 id="institute-name">{{ institute_name }}</h2>
        
            <!-- Home Button with Icon -->
            <button class="sidebar-item btn-primary" onclick="navigateTo('/home')" >
                <i class="sidebar-icon"> <i class="fas fa-home"></i> </i> <!-- Icon -->
                <span class="sidebar-text">Home</span> <!-- Text -->
              </button>

            <button class="sidebar-item btn-primary" onclick="navigateTo('/course')" >
            <i class="sidebar-icon"> <i class="fas fa-book course-icon"></i> </i> <!-- Icon -->
            <span class="sidebar-text">Course</span> <!-- Text -->
            </button>
        
            <!-- Logout Button -->

            <button class="sidebar-item logout-btn" onclick="navigateTo('/logout')">
                <i class="sidebar-icon"> <i class="fas fa-sign-out-alt"></i>  </i> <!-- Icon -->
                <span class="sidebar-text">Logout</span> <!-- Text -->
            </button>

            <!-- <button class="btn btn logout-btn" onclick="navigateTo('/logout')">Logout</button> -->
        </div>
        <div class="toggle-btn" onclick="toggleSidebar()">&#9664;</div>

        <!-- Main Content Area -->
        <div class="content" id="content">
            {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div 
                id="flash-message" 
                class="alert alert-{{ 'danger' if category == 'error' else 'success' }}"
                style="transition: opacity 0.5s ease-out;"
            >
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}
            <h1 class="mt-4">Dashboard</h1>

            <!-- Dropdowns and Add Student Button Row -->
            <div class="row mb-4 align-items-center">
                <!-- Search Form -->
                <form method="GET" action="{{ url_for('main.home') }}" class="col-md-6 d-flex align-items-center">
                    <div class="col-md-6">
                        <select class="form-control" name="course_id" id="python-dropdown"
                            onchange="filterByCourse(this)">
                            <option value="">All Courses</option>
                            {% for item in course %}
                            <option value="{{ item.id }}" {% if item.id==request.args.get('course_id')|int %}selected{%
                                endif %}>
                                {{ item.course_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <div class="search-container">
                            <input type="text" class="form-control" name="student_name" id="student-name"
                                placeholder="Search by name">
                            <i class="fas fa-search search-icon" onclick="triggerSearch()"></i>
                        </div>
                    </div>
                </form>

                <!-- Add Student Button -->
                <div class="col-md-3 ml-auto text-right">
                    <button class="btn btn-success btn-add" onclick="showStudentDetails()">
                        Add Student</button>
                </div>
            </div>

            <!-- Student Table -->
            <table class="table table-bordered mt-4">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Phone</th>
                        <th>Fees</th>
                        <th>Due Date</th>
                        <th>Course</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in students %}
                    <tr onclick="navigateTo('/student_details/{{ student.id }}')" style="cursor:pointer;">
                        <!-- <td>{{ loop.index }}</td> -->
                        <td>{{ student.student_name }}</td>
                        <td>{{ student.student_contact }}</td>
                        <td>
                            {% if upcoming_installments[student.id] %}
                            {% for installment in upcoming_installments[student.id] %}
                            {{ installment.amount|round }}<br>
                            {% endfor %}
                            {% else %}
                           
                            <span style="font-size: 20px; color: green;" title="All Fees Paid">&#9989;</span>
                            {% endif %}

                        </td>
                        <td>
                            {% if upcoming_installments[student.id] %}
                            {% for installment in upcoming_installments[student.id] %}
                            {{ installment.due_date }}<br>
                            {% endfor %}
                            {% else %}
                            <span style="color: white; font-style: italic; border-radius: 5px; padding: 5px;" class="btn-success">No due date</span>
                            {% endif %}
                        </td>
                        <td>{{ student.course.course_name }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>


            <!-- Pagination Controls -->
            <nav aria-label="Page navigation">
                <ul class="pagination">
                    {% if pagination.has_prev %}
                    <li class="page-item">
                        <a class="page-link"
                            href="{{ url_for('main.home', page=pagination.prev_num, course_id=course_id, student_name=student_name) }}">Previous</a>
                    </li>
                    {% endif %}
                    {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2)
                    %}
                    {% if page_num %}
                    <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                        <a class="page-link"
                            href="{{ url_for('main.home', page=page_num, course_id=course_id, student_name=student_name) }}">{{
                            page_num }}</a>
                    </li>
                    {% else %}
                    <li class="page-item disabled"><a class="page-link">...</a></li>
                    {% endif %}
                    {% endfor %}
                    {% if pagination.has_next %}
                    <li class="page-item">
                        <a class="page-link"
                            href="{{ url_for('main.home', page=pagination.next_num, course_id=course_id, student_name=student_name) }}">Next</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>

    <!-- Modal for Student Details -->
    <div class="modal fade" id="studentModal" tabindex="-1" aria-labelledby="studentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="studentModalLabel">Student Details</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form action="/addstu" method="POST">
                        <div class="form-group">
                            <label for="student-name">Name</label>
                            <input type="text" class="form-control" id="student-name" name="student_name" required>
                        </div>
                        <div class="form-group">
                            <label for="student-phone">Phone</label>
                            <input type="tel" class="form-control" id="student-phone" name="student_contact"
                                pattern="[0-9]{3}[0-9]{3}[0-9]{4}" required>
                        </div>
                        <div class="form-group">
                            <label for="student-email">Email</label>
                            <input type="email" class="form-control" id="student-email" name="student_mail" required>
                        </div>
                        <div class="form-group">
                            <label for="student-address">Address</label>
                            <input type="text" class="form-control" id="student-address" name="student_address"
                                required>
                        </div>

                        <div class="form-group">
                            <label for="student-course">Course</label>
                            <select class="form-control" id="student-course" name="course_id"
                                onchange="updateTotalAmount()">
                                <option value="" disabled selected>Select a Course</option>
                                {% for item in course %}
                                <option value="{{ item.id }}" data-price="{{ item.price }}">
                                    {{ item.course_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="installments">Installments</label>
                            <select class="form-control" id="installments" name="installments"
                                onchange="updateTotalAmount()">
                                <option value="1">1 Installment</option>
                                <option value="2">2 Installments</option>
                                <option value="3">3 Installments</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="discount">Discount (%)</label>
                            <input type="number" class="form-control" id="discount" name="discount" 
                                   placeholder="Enter discount percentage" min="0" max="100" onchange="updateTotalAmount()">
                        </div>
                        <div class="form-group">
                            <label for="student-total_payable_amnt">Total Payable Amount</label>
                            <input type="text" class="form-control" id="student-total_payable_amnt"
                                name="total_payable_amnt" readonly>
                        </div>

                        <button type="submit" class="btn btn-primary btn-submit">Add Student</button>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
   <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>


    <script>
        // Function to toggle the sidebar
        // function toggleSidebar() {
        //     document.getElementById("sidebar").classList.toggle("collapsed");
        //     document.getElementById("content").classList.toggle("collapsed");

        //     let toggleButton = document.querySelector(".toggle-btn");
        //     if (document.getElementById("sidebar").classList.contains("collapsed")) {
        //         toggleButton.innerHTML = "&#9654;";
        //     } else {
        //         toggleButton.innerHTML = "&#9664;";
        //     }
        // }

        function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const content = document.getElementById('content');
    const toggleBtn = document.querySelector('.toggle-btn');
    
    // Toggle collapsed class
    sidebar.classList.toggle('collapsed');
    content.classList.toggle('collapsed');

    // Adjust toggle button position
    if (sidebar.classList.contains('collapsed')) {
        toggleBtn.innerHTML = '&#9654;'; // Change arrow direction
    } else {
        toggleBtn.innerHTML = '&#9664;';
    }
}

        // Function to show the student details modal
        function showStudentDetails() {
            $('#studentModal').modal('show');
        }

        // Function to navigate to a specified URL
        function navigateTo(url) {
            window.location.href = url;
        }

        document.addEventListener('DOMContentLoaded', function () {
        const flashMessage = document.getElementById('flash-message');
        if (flashMessage) {
            // Set a timeout to remove the flash message after 3 seconds
            setTimeout(() => {
                flashMessage.style.opacity = '0'; // Fade out
                setTimeout(() => {
                    flashMessage.remove(); // Remove from DOM
                }, 500); // Wait for the fade-out transition
            }, 3000); // Delay of 3 seconds
        }
    });

        // Function to filter students by course
        function filterByCourse(dropdown) {
            const selectedCourseId = dropdown.value; // Get the selected course_id
            const baseUrl = "{{ url_for('main.home') }}"; // Base URL of the home route
            const newUrl = selectedCourseId
                ? `${baseUrl}?course_id=${selectedCourseId}` // Append course_id as query parameter
                : baseUrl; // If no selection, load the base URL

            window.location.href = newUrl; // Redirect to the new URL
        }
        function updateTotalAmount() {
            // Get the selected option from the dropdown
            const selectedCourse = document.getElementById("student-course");
            const price = selectedCourse.options[selectedCourse.selectedIndex].getAttribute("data-price");

            // Set the price to the Total Payable Amount field
            // document.getElementById("student-total_payable_amnt").value = price;
        }
        function updateTotalAmount() {
            // Get the selected course price
            const coursePrice = parseFloat(document.querySelector('#student-course').selectedOptions[0].dataset.price);

            // Get the selected installment option
            const installmentCount = parseInt(document.querySelector('#installments').value);

            const discountInput = parseFloat(document.getElementById("discount").value) || 0;


            // Initialize discount and total payable
            let discount = 0;

            // Apply discount based on the installment count
            if (installmentCount === 1) {
                discount = 0.25; 
            } else if (installmentCount === 2) {
                discount = 0.10; 
            }

            discount += discountInput / 100;
            // Ensure discount does not exceed 100%
            if (discount > 1) {
                alert("Total discount cannot exceed 100%");
                discount = 1;
            }


            // Calculate the total payable amount
            let totalAmount = coursePrice - (coursePrice * discount);
            totalAmount = totalAmount.toFixed(2); // Round to two decimal places

            // Set the total payable amount in the input field
            document.getElementById("student-total_payable_amnt").value = totalAmount;
        }

        // Function to trigger the search form submission
        function triggerSearch() {
            const form = document.querySelector('form'); // Select the form element
            form.submit(); // Programmatically submit the form
        }
    </script>
</body>

</html>